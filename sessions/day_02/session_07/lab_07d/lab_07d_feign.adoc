= Lab 07b - Declarative REST Clients with Feign

Estimated time to complete: 15 minutes
[abstract]
--
Let's continue learning the components found in Spring Cloud to implement patterns for distributed systems.
This lab is a small extension to the Ribbon lab. It uses Netflix Feign for the REST calls.
We will use a declarative REST repository based on Feign.


We will do the following:

. Improve the consumer application from link:../../session_07/lab_07a/lab_07a.adoc[Lab 07a] to use a `ProducerClient` enabled by Feign
. Test the new consumer version against our local pool of producers
--


== Setup

. You can just reuse the Eureka server and the 2 producers from Lab 07a as shown below:

|=======
|Eureka |http://localhost:8761
|Producer 1 |http://localhost:8080
|Producer 2 |http://localhost:8082 
|=======

In case you did not have time to complete the lab 07a, you can run all 3 application instances from the `complete` folder.


. Once you are ready to go, ensure you have two instances of the producer service registered in Eureka (http://locahost:8761):
+
image::../../../Common/images/ribbon_1.png[]

== Using Feign

. Change to the lab directory:
+
----
$ cd $COURSE_HOME/day_02/session_07/lab_07b/initial/springtrader-consumer
----
+
and import the project (via `pom.xml`) into your IDE of choice.

. Add the following dependency to `pom.xml`:
+
[source,xml]
----
<dependency>
	<groupId>org.springframework.cloud</groupId>
	<artifactId>spring-cloud-starter-feign</artifactId>
</dependency>
----

. Add a `@EnableFeignClients` annotation to the class `io.springtrader.consumer.SpringtraderConsumerApplication`.

. Create the interface `io.springtrader.consumer.ProducerClient` and into it paste the following code:
+
[source,java]
----
@FeignClient("producer")
public interface ProducerClient {

    @RequestMapping(method = RequestMethod.GET, value = "/")
    ProducerResponse getValue();
}
----

. Refactor the class `io.springtrader.consumer.ConsumerController` to autowire the `ProducerClient` instead of `RestTemplate`, and then use it to obtain the `ProducerResponse`:
+
[source,java]
----
@Autowired
ProducerClient client;

@RequestMapping(value = "/", produces = "application/json")
String consume() {
    ProducerResponse response = client.getValue();
    return String.format("{\"value\":%d}", response.getValue());
}
----

. Restart the `consumer` application by launching `SpringtraderConsumerApplication`

. Test the consumer application on http://localhost:8091/ and show that it is still receiving values from the producers. It should behave exactly like in the previous lab. The only difference is that your REST binding code is slightly more concise and elegant.
